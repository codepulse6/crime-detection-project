import tweepy
import requests
import json
from datetime import datetime

# Set your API keys/tokens here
TWITTER_API_KEY = 'your_twitter_api_key'
TWITTER_API_SECRET = 'your_twitter_api_secret'
TWITTER_ACCESS_TOKEN = 'your_twitter_access_token'
TWITTER_ACCESS_SECRET = 'your_twitter_access_secret'

FACEBOOK_ACCESS_TOKEN = 'your_facebook_access_token'
INSTAGRAM_ACCESS_TOKEN = 'your_instagram_access_token'

# Setup Twitter API client
def setup_twitter():
    auth = tweepy.OAuth1UserHandler(
        TWITTER_API_KEY, TWITTER_API_SECRET,
        TWITTER_ACCESS_TOKEN, TWITTER_ACCESS_SECRET
    )
    return tweepy.API(auth)

# Fetch tweets related to crime
def fetch_twitter_crime_posts(api, start_year, end_year):
    query = "crime OR theft OR attack OR murder"
    tweets = []
    for tweet in tweepy.Cursor(api.search_tweets, q=query, lang="en", since=str(start_year)+"-01-01", until=str(end_year)+"-12-31").items(50):
        tweets.append({
            'text': tweet.text,
            'created_at': tweet.created_at,
            'image': tweet.entities.get('media', [{}])[0].get('media_url', '')
        })
    return tweets

# Fetch Facebook posts (only from Pages you manage or public)
def fetch_facebook_crime_posts(start_year, end_year):
    query = "crime"
    url = f"https://graph.facebook.com/v18.0/search?access_token={FACEBOOK_ACCESS_TOKEN}&q={query}&type=page"
    response = requests.get(url)
    data = response.json()
    posts = []
    if 'data' in data:
        for page in data['data']:
            page_id = page['id']
            page_posts_url = f"https://graph.facebook.com/v18.0/{page_id}/posts?access_token={FACEBOOK_ACCESS_TOKEN}"
            posts_response = requests.get(page_posts_url)
            posts_data = posts_response.json()
            if 'data' in posts_data:
                for post in posts_data['data']:
                    created_time = datetime.strptime(post['created_time'], "%Y-%m-%dT%H:%M:%S%z")
                    if start_year <= created_time.year <= end_year:
                        posts.append({
                            'message': post.get('message', ''),
                            'created_time': post['created_time']
                        })
    return posts

# Main Chat Interface
def chat_box():
    print("Welcome to the Crime Post Fetcher!")
    year_range = input("Enter the year range (example: 2019 to 2021): ")
    start_year, end_year = map(int, year_range.split("to"))

    twitter_api = setup_twitter()

    print("\nFetching Twitter posts...")
    twitter_posts = fetch_twitter_crime_posts(twitter_api, start_year, end_year)
    print(f"Found {len(twitter_posts)} Twitter posts.")

    print("\nFetching Facebook posts...")
    facebook_posts = fetch_facebook_crime_posts(start_year, end_year)
    print(f"Found {len(facebook_posts)} Facebook posts.")

    # Instagram fetching would be similar but needs a proper Business Account setup
    print("\n(Instagram fetching needs Business Account setup, skipped here.)")

    # Display some results
    print("\n--- Twitter Posts ---")
    for post in twitter_posts[:5]:
        print(post)

    print("\n--- Facebook Posts ---")
    for post in facebook_posts[:5]:
        print(post)

if __name__ == "__main__":
    chat_box()

